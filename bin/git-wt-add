#!/usr/bin/env bash

# git-wt-add - Add a new branch/worktree
# Usage: git-wt-add <branch-name> [create-from-branch]

set -e

main() {
  if (($# < 1)) || (($# > 2)); then
    echo "Usage: git-wt-add <branch-name> [create-from-branch]"
    echo "Example: git-wt-add feature-new-feature"
    echo "Example: git-wt-add hotfix/login-bug main"
    exit 1
  fi

  BRANCH_NAME="${1}"
  FROM_BRANCH="${2}"
  DIR_NAME=$(echo "${BRANCH_NAME}" | tr '/' '-')

  if ! read common_dir rest < <(git worktree list 2>/dev/null | grep bare | cut -f 1); then
    echo "Error: Not in a git repository or .git directory not found"
    exit 1
  fi

  if [[ -d "${DIR_NAME}" ]]; then
    echo "Error: Worktree directory ${DIR_NAME} already exists"
    exit 1
  fi

  pushd "${common_dir}"

  cd "${common_dir}" >/dev/null || exit

  set -x
  if git rev-parse --verify "${BRANCH_NAME}" >/dev/null 2>&1; then
    # Branch exists locally
    git worktree add "${DIR_NAME}" "${BRANCH_NAME}"
    # Set up upstream tracking if remote branch exists
    if git rev-parse --verify "origin/${BRANCH_NAME}" >/dev/null 2>&1; then
      git branch --set-upstream-to=origin/"${BRANCH_NAME}" "${BRANCH_NAME}"
      echo "✅ Upstream tracking set: ${BRANCH_NAME} → origin/${BRANCH_NAME}"
    fi
  elif git rev-parse --verify "origin/${BRANCH_NAME}" >/dev/null 2>&1; then
    # Branch exists remotely - create worktree that tracks remote branch
    git worktree add "${DIR_NAME}" "origin/${BRANCH_NAME}"
    echo "✅ Worktree created with tracking: ${BRANCH_NAME} → origin/${BRANCH_NAME}"
  else
    # Branch doesn't exist, create it
    if [[ -n "${FROM_BRANCH}" ]]; then
      git worktree add -b "${BRANCH_NAME}" "${DIR_NAME}" "${FROM_BRANCH}"
    else
      git worktree add -b "${BRANCH_NAME}" "${DIR_NAME}"
    fi
    echo "ℹ️  New branch created. Use 'git push -u origin ${BRANCH_NAME}' to set up tracking"
  fi
  set +x

  popd

  # Auto-setup plugins if requested
  auto_setup=false
  if ${auto_setup}; then
    echo "Running auto-setup for worktree..."
    if command -v plugin-manager >/dev/null 2>&1; then
      plugin-manager auto-setup "${DIR_NAME}"
    else
      echo "Warning: plugin-manager not found. Install plugin system for auto-setup"
    fi
  fi

  echo ""
  echo "To work on this branch:"
  echo "  cd ${BRANCH_NAME}"
  echo ""
  echo "Current worktrees"
  git worktree list
}

if [[ -n "${BASH_SOURCE[0]}" && "${BASH_SOURCE[0]}" != "${0}" ]]; then
  return 0 2>/dev/null || exit 0 # This block will exit if file was sourced
fi

main "${@}" # If not sourced run main
