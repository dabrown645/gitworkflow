#!/usr/bin/env bash

# git-wt-clone - Clone a repository and set up worktree structure
# Usage: git-wt-clone <repo-url> [directory-name]

set -e

main() {
  if (($# < 1)) || (($# > 2)); then
    echo "Usage: git-wt-clone <repo-url> [directory-name]"
    echo "Example: git-wt-clone https://github.com/user/repo.git my_project"
    exit 1
  fi

  REPO_URL="$1"
  BASENAME="${REPO_URL##*/}"
  DIR_NAME="${2:-${BASENAME%.*}}" # Exatract dir_name from url if not provided

  clone_repo "${REPO_URL}" "${DIR_NAME}"

  cd "${DIR_NAME}"

  add_default_branch

  echo "✅ Repository cloned successfully"
  echo "✅  worktree for default branch: ${DIR_NAME}"
  echo ""
  echo "Directory structure:"
  echo "$DIR_NAME/"
  echo "├── $DEFAULT_BRANCH  # (current branch)"
  echo "└── .git"
  echo ""
  echo "To add a new branch worktree:"
  echo "  cd $DIR_NAME && git-worktree-add -b <type>/<branch-name> <type>-<branch-name> <from-branch>"
  echo ""
  echo "To list all worktrees:"
  echo "  cd $DIR_NAME && git worktree list"
}

clone_repo() {
  local repo="${1}"
  local dir="${2}"

  if [[ -d "${dir}" ]]; then
    echo "Error: Directory ${dir} already exists"
    exit 1
  fi

  echo "Cloning repository and setting up worktree structure..."

  # Create the main directory
  mkdir -p "$dir"
  cd "$dir"

  # Clone the repository (bare)
  git clone --bare "$repo" .git

  cd -
}

add_default_branch() {

  local default_branch
  default_branch=$(git rev-parse --abbrev-ref HEAD)

  # Create the main worktree for the default branch
  git worktree add "${default_branch}"
}

# This block will exit if file was sourced
if [[ ${BASH_SOURCE[0]} != "${0}" ]]; then
  return 0 2>/dev/null || exit 0
fi

# If not sourced run main
main "${@}"
