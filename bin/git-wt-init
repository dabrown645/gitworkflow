#!/usr/bin/env bash

# git-wt-init - Initialize a new project with worktree structure
# Usage: git-wt-init <project-name> [remote-url]

main() {
  parse_args "${@}"

  if is_git_url "$1"; then
    PROJECT_NAME=$(extract_repo_name "$1")
    REMOTE_URL="$1"
  else
    PROJECT_NAME="$1"
    REMOTE_URL="$2"
  fi

  exit_if_project_dir_exists

  init_project "${PROJECT_NAME}" "${REMOTE_URL}"

  result_summary
}

parse_args() {
  PARAMS=""

  while (("${#}")); do
    case "${1}" in
    --help | -h)
      show_help
      exit 0
      ;;
    --* | -*)
      errormsg "Invalid flag"
      show_help
      exit 1
      ;;
    *) PARAMS="$PARAMS \"${1}\"" ;;
    esac
    shift
  done

  eval set -- "${PARAMS}"

  if (($# < 1)) || (($# > 2)); then
    errormsg "You must supply at least a project name or git URL"
    show_help
    exit 1
  fi
}

show_help() {
  echo "Usage: git-wt-init <project-name-or-url> [remote-url] [ --help|-h]"
  echo ""
  echo "Description: git-wt-remove will initialize a new git repo and if"
  echo "     project or remote url is provide will configure the remote"
  echo ""
  echo "Examples:"
  echo "     git-wt-init my-new-project"
  echo "     git-wt-init https://github.com/user/repo.git"
  echo "     git-wt-init git@github.com:user/repo.git"
  echo "     git-wt-init my-project https://github.com/user/different.git"
}

is_git_url() {
  local input="$1"
  # Check for common Git URL patterns
  [[ "$input" =~ ^(https?|git|ssh|file):// ]] ||
    [[ "$input" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+:[^/]+/ ]] ||
    [[ "$input" =~ \.git$ ]]
}

extract_repo_name() {
  local url="$1"
  local basename="${url##*/}"
  echo "${basename%.git}"
}

exit_if_project_dir_exists() {
    if [[ -d "${PROJECT_NAME}" ]]; then
    errormsg "Directory ${PROJECT_NAME} already exists"
    exit 1
  fi
}

set_default_branch() {
  local remote="${1}"
  local default_branch
  default_branch=$(git config --global init.defaultBranch 2>/dev/null || echo "main")

  if [[ -n "${remote}" ]]; then
    if ! git ls-remote "${remote}" /dev/null 2>&1; then # Is remote url accessable
      errormsg "Could not access ${remote}"
      exit 1
    fi

    read -r _ DEFAULT_BRANCH _ < <(git ls-remote --symref "${remote}" HEAD 2>/dev/null | head -1)
    DEFAULT_BRANCH="${DEFAULT_BRANCH##*/}"
  fi

  DEFAULT_BRANCH=${DEFAULT_BRANCH:=${default_branch}}
}

init_project() {
  local project="$1"
  local remote="$2"

  echo "Initializing new project with worktree structure..."

  set_default_branch "${remote}"

  # Create main project directory
  mkdir -p "$project"

  # Initialize bare repository in .git directory
  git -C "${PWD}"/"${project}" init --bare .git

  # Configure remote if provided
  if [[ -n "${remote}" ]]; then
    git -C "${PWD}"/"${project}" config remote.origin.url "${remote}"
    git -C "${PWD}"/"${project}" config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
    echo "✅ Remote configured: ${remote}"
  fi

  # Create worktree for the default branch
  git -C "${PWD}"/"${project}" worktree add -b "${DEFAULT_BRANCH}" "${DEFAULT_BRANCH}"

  # Set up empty initial commit if remote is provided (for blank repos)
  if [[ -n "${remote}" ]]; then
    # Create an empty commit with empty message
    git -C "${PWD}"/"${project}"/"${DEFAULT_BRANCH}" commit --allow-empty --allow-empty-message --message ""
    echo "✅ Empty initial commit created"
  fi
}

result_summary() {
  echo "✅ Project initialized successfully"
  echo "✅ Worktree for ${DEFAULT_BRANCH} branch: ${PROJECT_NAME}/${DEFAULT_BRANCH}"
  echo ""
  echo "Directory structure:"
  echo "$PROJECT_NAME/"
  echo "├── ${DEFAULT_BRANCH}     # ${DEFAULT_BRANCH} branch worktree (current)"
  echo "│   └── .git"
  echo "└── .git                 # Bare repository"
  echo ""
  echo "Next steps:"
  if [[ -n "${REMOTE_URL}" ]]; then
    echo "  cd $PROJECT_NAME/${DEFAULT_BRANCH} && git push -u origin ${DEFAULT_BRANCH}"
  else
    echo "  cd $PROJECT_NAME/${DEFAULT_BRANCH} && add your files"
    echo "  git add . && git commit -m 'Initial commit'"
    echo "  # Then add remote and push:"
    echo "  git remote add origin <your-remote-url>"
    echo "  git push -u origin ${DEFAULT_BRANCH}"
  fi
  echo ""
  echo "To add a new branch worktree:"
  echo "  cd $PROJECT_NAME && git-wt-add <type>/<branch-name>"

}

errormsg() {
  echo "❌Error: ${*}" >&2
}

(return 0 2>/dev/null) || main "${@}"
