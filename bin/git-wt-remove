#!/usr/bin/env bash

# git-wt-remove - Safely remove a worktree
# Usage: git-wt-remove <branch-name> [--force]

set -e

if (($# < 1)) || (($# > 2)); then
  echo "Usage: git-wt-remove <branch-name> [--force]"
  echo "Example: git-wt-remove feature-new-feature"
  echo "Example: git-wt-remove hotfix-login-bug --force"
  exit 1
fi

WT_NAME="${1}"
if [[ "${2}" == "--force" ]]; then
  force=true
  FORCE="--force"
else
  force=false
  FORCE=""
fi

if ! read common_dir unused < <(git worktree list 2>/dev/null | grep bare | cut -f 1); then
  echo "Error: Not in a git repository or .git directory not found"
  exit 1
fi

if [[ "${PWD}" =~ ^${common_dir}/${WT_NAME} ]]; then
  echo "Error: Can't delete worktree ${WT_NAME} while inside it"
  exit 1
fi

current_dir=${PWD}

cd "${common_dir}" >/dev/null || exit

# Check if worktree exists
if [[ ! -d "${WT_NAME}" ]]; then
  echo "Error: Worktree directory ${WT_NAME} not found"
  echo "Available worktrees"
  git worktree list
  exit 1
fi

# Get worktree status
cd "${WT_NAME}" >/dev/null || exit
STATUS=$(git status --porcelain 2>/dev/null)
cd - >/dev/null || exit

# Check if the worktree is clean
if [[ -n "${STATUS}" ]]; then # STATUS not blank worktree is dirty
  if ${force}; then
    echo "⚠ Warning: Worktree '${WT_NAME}' has uncommitted changes"
    echo " These changes will be lost!"
    echo ""
    read -p "Are you sure you want to continue? (y/N): " confirm
    if [[ ! "${confirm}" =~ ^[Yy]$ ]]; then
      echo "Operation canclled"
      exit 0
    fi
  else
    echo "Error: Worktree ${WT_NAME} has uncommitted changes:"
    echo "${STATUS}"
    echo ""
    echo "Please commit or stash your changes first, or use --force to remove anyway"
    exit 1
  fi
fi

cd "${current_dir}"

echo "Removing worktree: ${WT_NAME}"
git worktree remove "${WT_NAME}" "${FORCE}"

echo "✅ Worktree removed successfully"
echo ""
echo "Remaining worktrees."
git worktree list
