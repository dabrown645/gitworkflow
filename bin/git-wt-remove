#!/usr/bin/env bash

# git-wt-remove - Safely remove a worktree
# Usage: git-wt-remove <branch-name> [--force]

main() {
  parse_args "${@}"

  set_common_dir

  exit_if_in_wt_to_delete

  exit_if_wt_dir_does_not_exist

  STATUS=$(git_worktree_status)
  if [[ -z "${STATUS}" ]]; then
    echo "âœ… Worktree ${WT_NAME} is clean"
    remove_worktree
  else
    if ${FORCE_SET}; then
      echo "âš  Warning: Worktree ${WT_NAME} has uncommitted changes"
      echo " These changes will be lost!"
      echo ""
      if confirm_removal; then
        remove_worktree
      else
        echo "Operation canceled" >&2
        exit 0
      fi
    else
      error_msg "Worktree ${WT_NAME} has uncommitted changes:"
      echo "${STATUS}"
      echo ""
      echo "Please commit or stash your changes first or use --force"
      exit 1
    fi
  fi

  exit 0
}

parse_args() {
  PARAMS=""

  FORCE="--no-force"
  FORCE_SET=false

  while (("${#}")); do
    case "${1}" in
    --force | -f)
      FORCE="--force"
      FORCE_SET=true
      ;;
    --help | -h)
      show_help
      exit 0
      ;;
    --* | -*)
      echo "Invalid flag"
      show_help
      exit 1
      ;;
    *)
      PARAMS="${PARAMS} \"${1}\""
      ;;
    esac
    shift
  done

  eval set -- "${PARAMS}"

  if (($# != 1)); then
    echo "You must supply one worktree to delete"
    echo ""
    show_help
    exit 1
  fi

  WT_NAME="${1}"
}

show_help() {
  echo "Usage: git-wt-remove <worktree-name> [--force|-f] [--help|-h]"
  echo ""
  echo "Description: git-wt-remove removes a worktree but NOT the associated branch"
  echo ""
  echo "Options:"
  echo "  --force|-f      Remove worktree even if it has uncommitted changes"
  echo "  --help|-h       Show this help"
  echo ""
  echo "Examples:"
  echo "  git-wt-remove feature-worktree"
  echo "  git-wt-remove old-worktree --force"
  echo ""
  echo "A worktree can only be removed if you're not currently in it."
  echo ""
}

set_common_dir() {
  if ! read -r COMMON_DIR _ < <(git worktree list 2>/dev/null | grep bare | cut -f 1); then
    echo "You are not in a git repository" >&2
    exit 1
  fi
}

exit_if_in_wt_to_delete() {
  if [[ "${PWD}" =~ ^${COMMON_DIR}/${WT_NAME}$ ]]; then
    error_msg "Can't delete worktree <${WT_NAME}> while inside it"
    exit 1
  fi
}

exit_if_wt_dir_does_not_exist() {
  if [[ ! -d ${COMMON_DIR}/${WT_NAME} ]]; then
    error_msg "Worktree directory <${WT_NAME} does not exist"
    exit 1
  fi
}

confirm_removal() {
  read -r -p "Are you sure you want to continue? (y/N): " confirm
  if [[ "${confirm}" =~ ^[Yy]$ ]]; then
    return 0
  else
    echo "Operation cancelled"
    return 1
  fi
}

remove_worktree() {
  echo "ðŸ—‘ï¸  Deleting clean worktree <${WT_NAME}> as requested"

  if run_git_in_common_dir worktree remove "${WT_NAME}" "${FORCE}"; then
    echo "âœ… Worktree removed successfully"
    echo ""
    echo "Remaining worktrees:"

    run_git_in_common_dir worktree list
    exit 0
  else
    error_msg "Worktree removal failed"
    exit 1
  fi
}

git_worktree_status() {
  git -C "${COMMON_DIR}"/"${WT_NAME}" status --porcelain
}

run_git_in_common_dir() {
  git -C "${COMMON_DIR}" "${@}"
}

error_msg() {
  echo "âŒError: ${*}" >&2
}

(return 0 2>/dev/null) || main "${@}"
