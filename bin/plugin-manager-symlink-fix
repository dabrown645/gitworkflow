#!/bin/bash

# plugin-manager - Manages language-specific plugins for git worktrees
# Usage: plugin-manager <command> [args]

set -e

# Resolve symlink to actual directory - use dirname of the script location
SCRIPT_DIR="$(dirname "$(readlink -f "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)" 2>/dev/null || echo "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")")"
PLUGINS_DIR="$SCRIPT_DIR/plugins"
AVAILABLE_DIR="$PLUGINS_DIR/available"
ENABLED_DIR="$PLUGINS_DIR/enabled"
CONFIG_DIR="$PLUGINS_DIR/config"

# Load configuration
load_config() {
    # Search for config file in XDG_CONFIG_DIR first, then fallback to local config
    local config_locations=(
        "${XDG_CONFIG_DIR:-$HOME/.config}/gitworkflow/plugins/config/default.yaml"
        "$CONFIG_DIR/default.yaml"
    )
    
    for config_file in "${config_locations[@]}"; do
        if [[ -f "$config_file" ]]; then
            # Parse YAML (basic key-value parsing)
            while IFS=':' read -r key value; do
                [[ "$key" =~ ^[[:space:]]*# ]] && continue
                [[ -z "$key" ]] && continue
                key=$(echo "$key" | xargs)
                value=$(echo "$value" | xargs)
                # Skip invalid keys and complex YAML structures
                if [[ "$key" =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]] && [[ "$value" != *"["* ]] && [[ "$value" != *"]"* ]]; then
                    export PLUGIN_CONFIG_$key="$value"
                fi
            done < "$config_file"
            break  # Use first found config file
        fi
    done
}